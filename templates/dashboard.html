{% extends 'base.html' %}
{% block content %}
<div class="container">
  <!-- Welcome Section -->
  <div class="card dashboard-hero">
    <h2>Welcome, {{ user.name }}</h2>
    <p class="small">Role: <span class="badge">{{ user.role }}</span></p>
    
    <!-- Quick Action Buttons -->
    <div style="display:flex; gap:12px; margin-top:16px; flex-wrap:wrap">
      {% if current_user and current_user.role == 'admin' %}
        <a href="/admin" class="btn btn-primary">ğŸ‘¨â€ğŸ’¼ Admin Panel</a>
      {% elif current_user and current_user.role == 'teacher' %}
        <a href="/teacher/classes" class="btn btn-primary">ğŸ“š My Classes</a>
        <a href="/resources" class="btn btn-secondary">ğŸ“„ Resources</a>
      {% else %}
        {% if current_user and current_user.role == 'student' %}
        <a href="/join_class" class="btn btn-primary">â• Join Class</a>
        {% endif %}
        <a href="/progress" class="btn btn-secondary">ğŸ“Š View Progress</a>
      {% endif %}
      <a href="/profile" class="btn btn-secondary">âš™ï¸ Edit Profile</a>
      <a href="/logout" class="btn" style="background:#dc3545; color:#fff">ğŸšª Logout</a>
    </div>
  </div>

  <div class="grid">
    <!-- Main Content Area -->
    <div>
      <!-- Courses Section -->
      <div class="card">
        <h3>ğŸ“š Your Courses</h3>
        {% if courses %}
          <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); gap: 12px; margin-top: 16px">
            {% for c in courses %}
              <div class="course-card">
                <h4 style="margin-top: 0"><a href="/course/{{ c.id }}">{{ c.title or ('Course ' ~ loop.index) }}</a></h4>
                <p class="small">{{ c.description or 'No description' }}</p>
                <div style="margin-top:12px; display:flex; gap:8px; align-items:center">
                  <a class="link-button" href="/course/{{ c.id }}">âœ Open Course</a>
                  {% if current_user.role == 'admin' %}
                  <form action="{{ url_for('delete_course_route', course_id=c.id) }}" method="post" style="display:inline" onsubmit="return confirm('Are you sure you want to delete this course? This cannot be undone.');">
                    <button type="submit" class="link-button" style="color:var(--danger); border:none; padding:0; background:transparent; font-size:14px; font-weight:600;">ğŸ—‘ï¸ Delete</button>
                  </form>
                  {% endif %}
                </div>
              </div>
            {% endfor %}
          </div>
        {% else %}
          <p class="small">ğŸ“­ No courses yet. 
          {% if current_user.role == 'student' %}<a href="/join_class">Join a class</a>{% endif %}</p>
        {% endif %}
      </div>

      <!-- Resources Section -->
      <div class="card">
        <div style="display:flex; justify-content:space-between; align-items:center">
          <h3 style="margin: 0">ğŸ“„ Learning Resources</h3>
          {% if current_user and current_user.role == 'teacher' %}
            <a href="/resources/create" class="btn btn-small" style="background:var(--success); color:#fff; padding:8px 12px">+ Add Resource</a>
          {% endif %}
        </div>
        
        {% if resources and resources|length > 0 %}
          <div style="display: grid; grid-template-columns: 1fr; gap: 12px; margin-top: 16px">
            {% for r in resources %}
              <div style="padding:12px; background:var(--surface); border-radius:var(--radius); border:1px solid var(--border)">
                <div style="display:flex; justify-content:space-between; align-items:flex-start">
                  <div>
                    <h4 style="margin:0 0 6px 0">{{ r.title }}</h4>
                    <p class="small" style="margin:0 0 6px 0">{{ (r.content or '')[:100] }}{% if (r.content or '')|length > 100 %}...{% endif %}</p>
                    <span class="badge">{{ r.type }}</span>
                    {% if r.teacher_name %}<span class="small">by {{ r.teacher_name }}</span>{% endif %}
                  </div>
                  <div style="display:flex; gap:8px; align-items:center; flex-shrink: 0;">
                    <a href="/resource/{{ r.id }}" class="link-button">ğŸ“– View</a>
                    {% if current_user and (current_user.role == 'admin' or (r.teacher_id and current_user.id == r.teacher_id)) %}
                    <form action="{{ url_for('delete_resource_route', resource_id=r.id) }}" method="post" style="display:inline;" onsubmit="return confirm('Are you sure you want to delete this resource? This cannot be undone.');">
                        <button type="submit" class="link-button" style="color:var(--danger); border:none; padding:0; background:transparent; font-size:14px; font-weight:600;">ğŸ—‘ï¸ Delete</button>
                    </form>
                    {% endif %}
                  </div>
                </div>
              </div>
            {% endfor %}
          </div>
        {% else %}
          <p class="small" style="margin-top:16px">ğŸ“­ No resources available yet.</p>
        {% endif %}
      </div>
    </div>

    <!-- Sidebar -->
    <aside>
      <!-- Progress Card -->
      {% if progress %}
      <div class="card" style="text-align:center">
        <h4>ğŸ“ˆ Your Progress</h4>
        <div class="progress-circle" style="--deg: {{ progress.deg }}deg; margin: 0 auto 16px">
          <div class="progress-center">
            <div class="pct">{{ progress.pct }}%</div>
            <div class="small">Complete</div>
          </div>
        </div>
        <p class="small"><strong>{{ progress.completed }}</strong> / {{ progress.total }} lessons done</p>
        <p class="small">Avg. Quiz Score: <strong>{{ progress.avg if progress.avg is not none else 'N/A' }}</strong></p>
      </div>
      {% endif %}

      <!-- User Info Card -->
      <div class="card">
        <h4>ğŸ‘¤ Your Account</h4>
        <p class="small"><strong>{{ user.name }}</strong><br>{{ user.email }}</p>
        <hr />
        <div style="display:flex; flex-direction:column; gap:8px">
          <a href="/profile" class="btn btn-secondary" style="text-align:center">âš™ï¸ Edit Profile</a>
          <a href="/logout" class="btn" style="text-align:center; background:#dc3545; color:#fff">ğŸšª Logout</a>
        </div>
      </div>
    </aside>
  </div>
</div>
  <script>
  // Courses slider + search â€” simplified: slides are scrollable, search filters items
  (function(){
    const slider = document.getElementById('coursesSlider');
    const search = document.getElementById('courseSearch');
    if (!slider) return;

    if (search){
      search.addEventListener('input', ()=>{
        const q = search.value.trim().toLowerCase();
        const items = slider.querySelectorAll('.course-card');
        items.forEach(it => {
          const title = it.getAttribute('data-title') || '';
          it.style.display = (!q || title.indexOf(q) !== -1) ? '' : 'none';
        });
        slider.scrollLeft = 0;
      });
    }
    // enable mouse dragging on desktop for nicer UX
    let isDown = false, startX, scrollLeft;
    slider.addEventListener('mousedown', (e)=>{ isDown=true; slider.classList.add('dragging'); startX = e.pageX - slider.offsetLeft; scrollLeft = slider.scrollLeft; });
    slider.addEventListener('mouseleave', ()=>{ isDown=false; slider.classList.remove('dragging'); });
    slider.addEventListener('mouseup', ()=>{ isDown=false; slider.classList.remove('dragging'); });
    slider.addEventListener('mousemove', (e)=>{ if(!isDown) return; e.preventDefault(); const x = e.pageX - slider.offsetLeft; const walk = (x - startX) * 1; slider.scrollLeft = scrollLeft - walk; });
  })();
  </script>
  <script>
  // Resources slider + search on dashboard
  (function(){
    const rSlider = document.getElementById('resourcesSlider');
    const rSearch = document.getElementById('resourceSearchDashboard');
    if (!rSlider) return;
    if (rSearch){
      rSearch.addEventListener('input', ()=>{
        const q = rSearch.value.trim().toLowerCase();
        const items = rSlider.querySelectorAll('.course-card');
        items.forEach(it => {
          const title = it.getAttribute('data-title') || '';
          it.style.display = (!q || title.indexOf(q) !== -1) ? '' : 'none';
        });
        rSlider.scrollLeft = 0;
      });
    }
    // drag to scroll
    let isDownR = false, startXR, scrollLeftR;
    rSlider.addEventListener('mousedown', (e)=>{ isDownR=true; rSlider.classList.add('dragging'); startXR = e.pageX - rSlider.offsetLeft; scrollLeftR = rSlider.scrollLeft; });
    rSlider.addEventListener('mouseleave', ()=>{ isDownR=false; rSlider.classList.remove('dragging'); });
    rSlider.addEventListener('mouseup', ()=>{ isDownR=false; rSlider.classList.remove('dragging'); });
    rSlider.addEventListener('mousemove', (e)=>{ if(!isDownR) return; e.preventDefault(); const x = e.pageX - rSlider.offsetLeft; const walk = (x - startXR) * 1; rSlider.scrollLeft = scrollLeftR - walk; });
  })();
  </script>
{% endblock %}
